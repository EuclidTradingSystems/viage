name: Windows

on:
  push

env:
  BUILD_TYPE: Release
  QT_VERSION: 6.6.2
  IFW_VERSION: 4.7

jobs:
  build_release:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: seanmiddleditch/gha-setup-ninja@v4

    # - run: pip install aqtinstall
    # - run: aqt install-qt windows desktop ${{env.QT_VERSION}} win64_mingw -m qtmultimedia
    # - run: aqt install-tool windows desktop qt.tools.ifw.${{env.IFW_VERSION}}

    - uses: jurplel/install-qt-action@v3
      with:
       version: ${{env.QT_VERSION}}
       host: 'windows'
       target: 'desktop'
       arch: 'win64_mingw'
       modules: 'qtmultimedia'
       tools: 'tools_ifw'
       dir: ${{ github.workspace }}

    - run: mkdir build

    - name: Configure CMake
      working-directory: ./build
      run: >
        cmake .. -GNinja
        -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}
        -DSERVER=OFF    
        -DCMAKE_PREFIX_PATH="${{github.workspace}}/${{env.QT_VERSION}}/mingw_64"
        -DCPACK_IFW_ROOT="${{github.workspace}}/Tools/QtInstallerFramework/${{env.IFW_VERSION}}"

    - name: Build
      run: cmake --build build --target package

    - uses: actions/upload-artifact@v3
      with:
        name: viage
        path: ${{github.workspace}}/build/viage-*-win64.exe
